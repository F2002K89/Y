<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Client Dashboard â€” Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="../logo.png" type="image/png">
  <!-- Ace editor CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js" crossorigin="anonymous"></script>
</head>
<body class="min-h-screen bg-gray-50 font-sans">
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="../logo.png" alt="NEFT" class="h-8 w-8">
        <h1 class="text-lg font-semibold">Client Dashboard</h1>
      </div>
      <div class="flex items-center gap-3">
        <span id="userEmail" class="text-sm text-gray-600"></span>
        <button id="logout" class="text-sm text-red-600">Sign out</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">
    <div class="bg-white rounded-xl p-6 shadow">
      <h2 class="text-xl font-bold mb-2">Code Editor</h2>
      <p class="text-gray-600 mb-4">Write code below. This is a demo editor using Ace. Save to localStorage or download the file.</p>

      <div class="mb-3 flex gap-2">
        <select id="mode" class="border px-2 py-1 rounded">
          <option value="javascript">JavaScript</option>
          <option value="html">HTML</option>
          <option value="python">Python</option>
          <option value="css">CSS</option>
        </select>
        <button id="saveLocal" class="bg-green-600 text-white px-3 py-1 rounded">Save to browser</button>
        <button id="download" class="bg-blue-600 text-white px-3 py-1 rounded">Download .txt</button>
      </div>

      <div id="editor" style="height:420px;border:1px solid #e5e7eb;border-radius:8px;"></div>
    </div>
  </main>

  <div id="kyc-area" class="mt-4">
  <button id="startKycBtn" class="bg-black text-white px-4 py-2 rounded">Start KYC</button>
  <span id="kycStatusText" style="margin-left:12px;color:#333;"></span>
</div>

<script>
  async function checkKycStatus() {
    const email = localStorage.getItem('client_email') || '';
    if (!email) { document.getElementById('kycStatusText').textContent = 'Please sign in.'; return; }
    try {
      const res = await fetch('/api/kyc/status', { headers: { 'X-User-Email': email }});
      if (!res.ok) { document.getElementById('kycStatusText').textContent = 'Status unavailable'; return; }
      const j = await res.json();
      document.getElementById('kycStatusText').textContent = 'KYC: ' + (j.kycStatus || 'not_started');
    } catch (err) {
      document.getElementById('kycStatusText').textContent = 'Status error';
    }
  }

  document.getElementById('startKycBtn').addEventListener('click', async () => {
    const email = localStorage.getItem('client_email') || prompt('Enter email (demo mapping):');
    if (!email) return alert('Email required');
    localStorage.setItem('client_email', email);
    try {
      const resp = await fetch('/api/kyc/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-User-Email': email },
        body: JSON.stringify({ name: localStorage.getItem('client_name') || '' })
      });
      if (!resp.ok) {
        const j = await resp.json().catch(()=>({message:resp.statusText}));
        return alert('Failed to start KYC: ' + (j.message || resp.statusText));
      }
      const { verificationUrl } = await resp.json();
      if (!verificationUrl) return alert('No verification URL returned by provider');
      window.location.href = verificationUrl; // redirect user to DIDIT flow
    } catch (err) {
      alert('Error starting KYC: ' + err.message);
    }
  });

  checkKycStatus();
  setInterval(checkKycStatus, 15000);
</script>
